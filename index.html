<!doctype html>
<html lang="th">
<head>
<meta http-equiv="Cache-Control" content="no-store" />
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>ยืนยันการแลก (Admin)</title>
<style>
  :root{ --bg:#f6f8fd;--card:#fff;--line:#e6e9f2;--txt:#0f1733;--muted:#6b78a6;--ok:#0a8c4a;--danger:#d93025;--btn:#1f6fff;}
  body{margin:0;background:var(--bg);font:16px/1.6 system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial,sans-serif;color:var(--txt);}
  .wrap{max-width:620px;margin:24px auto;padding:16px;}
  .card{background:#fff;border:1px solid var(--line);border-radius:14px;box-shadow:0 10px 30px rgba(15,23,51,.06);padding:20px;}
  h1{margin:0 0 8px;font-size:22px}
  .row{display:flex;gap:12px;align-items:center;margin:10px 0}
  .key{width:140px;color:var(--muted)}
  input,select,button{font:inherit;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff}
  input,select{flex:1}
  .btn{background:var(--btn);color:#fff;border:none;cursor:pointer}
  .btn[disabled]{opacity:.5;cursor:not-allowed}
  .hint{color:var(--muted);font-size:13px}
  .ok{color:var(--ok)} .err{color:var(--danger)}
  .pill{display:inline-block;background:#eef3ff;border:1px solid #dfe7ff;padding:4px 10px;border-radius:999px;font-size:13px}
  .mt{margin-top:16px}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>✅ ยืนยันการแลก (Admin)</h1>
    <p class="hint">ตรวจสอบข้อมูลการแลกรางวัลให้ถูกต้อง</p>

    <div class="row"><div class="key">SAP</div><div id="sap" class="pill">—</div></div>
    <div class="row"><div class="key">ชื่อผู้แลก</div><div id="userName" class="pill">กำลังดึง…</div></div>
    <div class="row"><div class="key">รางวัล</div><div id="reward" class="pill">—</div></div>
    <div class="row"><div class="key">แต้มที่ใช้</div><div id="points" class="pill">—</div></div>

    <div class="row mt">
      <div class="key">รับแลกโดย</div>
      <input id="adminName" placeholder="ชื่อจริง เช่น จุฑาวุฒิ">
    </div>
    <div class="row">
      <div class="key">หรือเลือก</div>
      <select id="adminSelect"><option value="">— โหลดรายชื่อแอดมิน… —</option></select>
    </div>

    <div class="row mt">
      <button id="btnConfirm" class="btn">ยืนยันแลก</button>
      <button id="btnCancel" type="button">ยกเลิก</button>
    </div>

    <p id="msg" class="mt hint"></p>
  </div>
</div>

<script>
/* ========= CONFIG ========= */
const GAS_URL = "https://script.google.com/macros/s/AKfycbwPOW_Wk7bZYb3zG4qRciOENbBSMo2TRdfdJxXzC1C5tRxav1R_dlF5SuuXKoEkJi84Ig/exec";
const DB_URL  = "https://anesaplus-default-rtdb.asia-southeast1.firebasedatabase.app";

/* ========= helpers ========= */
function $(id){ return document.getElementById(id); }
function fmt(n){ return Number(n||0).toLocaleString('th-TH'); }
function explain(err){
  const e = String(err||'').toLowerCase();
  if(e==='missing_params')    return 'ข้อมูลไม่ครบ (SAP, รางวัล, แต้ม, แอดมิน)';
  if(e==='user_not_found')    return 'ไม่พบผู้ใช้ในระบบ';
  if(e==='reward_not_found')  return 'ไม่พบชื่อรางวัล';
  if(e==='out_of_stock')      return 'ของรางวัลหมดสต็อก';
  if(e==='not_enough_points') return 'แต้มไม่เพียงพอ';
  return 'ไม่สามารถบันทึกได้ ('+(err||'unknown')+')';
}

/* JSONP สำหรับ Apps Script */
function jsonp(params){
  return new Promise((resolve,reject)=>{
    const cb = "cb_"+Math.random().toString(36).slice(2);
    params = {...params, callback: cb};
    const url = GAS_URL + "?" + new URLSearchParams(params).toString();
    const s = document.createElement("script");
    const timer = setTimeout(()=>{ cleanup(); reject(new Error("timeout")); }, 15000);
    function cleanup(){ delete window[cb]; try{s.remove();}catch{} clearTimeout(timer); }
    window[cb] = (res)=>{ cleanup(); resolve(res); };
    s.onerror = ()=>{ cleanup(); reject(new Error("network_error")); };
    s.src = url; document.body.appendChild(s);
  });
}

/* ========= decode payload จาก QR (ยืดหยุ่นหลายคีย์) ========= */
function decodePayload(){
  const first = (...xs)=> xs.find(v=> (v!==undefined && v!==null && String(v).trim()!=='')) ?? '';

  // hash: #p=base64(json)
  try{
    const hp = new URLSearchParams(location.hash.slice(1));
    const b64 = hp.get('p');
    if(b64){
      const json = decodeURIComponent(escape(window.atob(b64)));
      const o = JSON.parse(json);
      const sap    = first(o.sap, o.SAP, o.userSap, o.user, o.uid);
      const reward = first(o.rewardName, o.reward, o.rewardTitle, o.title, o.label, o.name);
      const pts    = Number(first(o.points, o.pts, o.pointsRequired, o.cost, o.needPoints, o.requiredPoints, o.required));
      const ts     = first(o.ts, o.timestamp, o.time);
      return { sap:String(sap||'').trim(), reward:String(reward||'').trim(), pts:(isNaN(pts)?0:pts), ts:String(ts||'').trim() };
    }
  }catch(_){}

  // query: ?sap=...&reward=...&points=...
  const q = new URLSearchParams(location.search);
  const sap    = first(q.get('sap'), q.get('SAP'), q.get('userSap'), q.get('user'), q.get('uid'));
  const reward = first(q.get('rewardName'), q.get('reward'), q.get('rewardTitle'), q.get('title'), q.get('label'), q.get('name'));
  const pts    = Number(first(q.get('points'), q.get('pts'), q.get('pointsRequired'), q.get('cost'), q.get('needPoints'), q.get('requiredPoints'), q.get('required')));
  const ts     = first(q.get('ts'), q.get('timestamp'), q.get('time'));
  return { sap:String(sap||'').trim(), reward:String(reward||'').trim(), pts:(isNaN(pts)?0:pts), ts:String(ts||'').trim() };
}

/* ========= RTDB: ดึงชื่อผู้ใช้ ========= */
async function fetchUserNameFromRTDB(sap){
  if(!sap) return null;
  try{
    const r = await fetch(`${DB_URL}/public/usersSummary/${encodeURIComponent(sap)}.json?t=${Date.now()}`, {cache:'no-store'});
    if(!r.ok) return null;
    const v = await r.json();
    if(v && typeof v==='object') return v.name || v.Name || null;
  }catch(_){}
  return null;
}

/* ========= โหลดรายชื่อแอดมินจากชีต getAdmins/Admins ========= */
async function loadAdmins(){
  const sel = $("adminSelect");
  sel.innerHTML = '<option value="">— เลือกชื่อแอดมิน —</option>';
  try{
    const res = await jsonp({ action: "getAdmins" }); // server จะ toLowerCase → 'getadmins'
    const items = (res && res.items) || [];
    if(Array.isArray(items) && items.length){
      for(const it of items){
        const name = (it.name || it).toString();
        const opt = document.createElement('option');
        opt.value = name;              // ← ส่ง “ชื่อ” กลับ GAS
        opt.textContent = it.sap ? `${name} (${it.sap})` : name;
        sel.appendChild(opt);
      }
      return;
    }
  }catch(_){}
  // fallback เผื่อเรียกลิสต์ไม่ได้
  sel.insertAdjacentHTML('beforeend','<option value="Tachawan">Tachawan</option>');
  sel.insertAdjacentHTML('beforeend','<option value="Dudsadee">Dudsadee</option>');
  sel.insertAdjacentHTML('beforeend','<option value="Juthawut">Juthawut</option>');
}

/* ========= เรียกยืนยันแลกไป GAS ========= */
async function confirmRedeemViaGAS(payload){
  let r = await jsonp({ action:'confirmRedeem', ...payload });
  if(r && (r.ok || r.error!=='unknown_action')) return r;
  r = await jsonp({ act:'confirmRedeem', ...payload });
  if(r && (r.ok || r.error!=='unknown_action')) return r;
  r = await jsonp({ a:'confirmRedeem', ...payload });
  return r;
}

/* ========= MAIN ========= */
(async ()=>{
  const data = decodePayload();
  $("sap").textContent    = data.sap || "—";
  $("reward").textContent = data.reward || "—";
  $("points").textContent = data.pts ? fmt(data.pts) : "—";

  // ชื่อผู้ใช้: RTDB → fallback GAS
  let userName = await fetchUserNameFromRTDB(data.sap);
  if(!userName){
    try{
      const r = await jsonp({ action:'userstatus', sap:data.sap });
      userName = (r && r.name) || null;
    }catch(_){}
  }
  $("userName").textContent = userName || "—";

  await loadAdmins();

  // sync input กับ select
  $("adminSelect").addEventListener("change", e=>{
    if(e.target.value) $("adminName").value = e.target.value;
  });

  let locking = false;
  $("btnConfirm").addEventListener("click", async ()=>{
    if(locking) return;
    const msg = $("msg");
    msg.className = "mt hint";

    if(!data.sap || !data.reward || !data.pts){
      msg.textContent = "❌ ข้อมูลไม่ครบจาก QR"; return;
    }
    const adminName = $("adminName").value.trim() || $("adminSelect").value.trim();
    if(!adminName){ msg.textContent = "กรุณาเลือก/พิมพ์ชื่อแอดมิน"; $("adminName").focus(); return; }

    $("btnConfirm").disabled = true;
    locking = true;
    msg.textContent = "กำลังบันทึก…";

    try{
      const res = await confirmRedeemViaGAS({
        sap: data.sap,
        rewardName: data.reward,
        points: data.pts,
        adminName,
        ts: data.ts
      });

      if(res && res.ok){
        const afterTotal = ('totalAfter' in res) ? fmt(res.totalAfter) : '—';
        const afterStock = ('stockAfter' in res) ? fmt(res.stockAfter) : '—';
        msg.className = "mt ok";
        msg.innerHTML = `✅ สำเร็จ — แต้มคงเหลือผู้ใช้: <b>${afterTotal}</b> | สต็อกรางวัลคงเหลือ: <b>${afterStock}</b><br>หน้านี้จะปิดอัตโนมัติ`;
        setTimeout(()=>window.close(), 1500);
      }else{
        $("btnConfirm").disabled = false;
        locking = false;
        msg.className = "mt err";
        msg.textContent = "❌ " + explain(res && res.error);
      }
    }catch(e){
      $("btnConfirm").disabled = false;
      locking = false;
      msg.className = "mt err";
      msg.textContent = "❌ เกิดข้อผิดพลาดในการเชื่อมต่อ";
    }
  });

  $("btnCancel").addEventListener("click", ()=>history.back());
})();
</script>

</body>
</html>
