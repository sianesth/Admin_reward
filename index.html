<!doctype html>
<html lang="th">
<head>
<meta http-equiv="Cache-Control" content="no-store" />
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å (Admin)</title>
<style>
  :root{ --bg:#f6f8fd;--card:#fff;--line:#e6e9f2;--txt:#0f1733;--muted:#6b78a6;--ok:#0a8c4a;--danger:#d93025;--btn:#1f6fff;}
  body{margin:0;background:var(--bg);font:16px/1.6 system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial,sans-serif;color:var(--txt);}
  .wrap{max-width:620px;margin:24px auto;padding:16px;}
  .card{background:#fff;border:1px solid var(--line);border-radius:14px;box-shadow:0 10px 30px rgba(15,23,51,.06);padding:20px;}
  h1{margin:0 0 8px;font-size:22px}
  .row{display:flex;gap:12px;align-items:center;margin:10px 0}
  .key{width:140px;color:var(--muted)}
  input,select,button{font:inherit;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff}
  input,select{flex:1}
  .btn{background:var(--btn);color:#fff;border:none;cursor:pointer}
  .btn[disabled]{opacity:.5;cursor:not-allowed}
  .hint{color:var(--muted);font-size:13px}
  .ok{color:var(--ok)} .err{color:var(--danger)}
  .pill{display:inline-block;background:#eef3ff;border:1px solid #dfe7ff;padding:4px 10px;border-radius:999px;font-size:13px}
  .mt{margin-top:16px}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å (Admin)</h1>
    <p class="hint">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</p>

    <div class="row"><div class="key">SAP</div><div id="sap" class="pill">‚Äî</div></div>
    <div class="row"><div class="key">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÅ‡∏•‡∏Å</div><div id="userName" class="pill">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‚Ä¶</div></div>
    <div class="row"><div class="key">‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</div><div id="reward" class="pill">‚Äî</div></div>
    <div class="row"><div class="key">‡πÅ‡∏ï‡πâ‡∏°‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ</div><div id="points" class="pill">‚Äî</div></div>

    <div class="row mt">
      <div class="key">‡∏£‡∏±‡∏ö‡πÅ‡∏•‡∏Å‡πÇ‡∏î‡∏¢</div>
      <input id="adminName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á ‡πÄ‡∏ä‡πà‡∏ô ‡∏à‡∏∏‡∏ë‡∏≤‡∏ß‡∏∏‡∏í‡∏¥">
      <input id="adminSAP" type="hidden" value="">
    </div>
    <div class="row">
      <div class="key">‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div>
      <select id="adminSelect"><option value="">‚Äî ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‚Ä¶ ‚Äî</option></select>
    </div>

    <div class="row mt">
      <button id="btnConfirm" class="btn">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏Å</button>
      <button id="btnCancel" type="button">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    </div>

    <p id="msg" class="mt hint"></p>
  </div>
</div>

<footer style="text-align:center;color:#8b94b2;font-size:11px;margin:8px 0">
  ¬© 2025 | ‡∏†‡∏≤‡∏Ñ‡∏ß‡∏¥‡∏ä‡∏≤‡∏ß‡∏¥‡∏™‡∏±‡∏ç‡∏ç‡∏µ‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤ ‡∏Ñ‡∏ì‡∏∞‡πÅ‡∏û‡∏ó‡∏¢‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏®‡∏¥‡∏£‡∏¥‡∏£‡∏≤‡∏ä‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏• | Version 1.0 by Zuree.Yoo

</footer>

<script>
/* ========= CONFIG ========= */
const GAS_URL = "https://script.google.com/macros/s/AKfycbwPOW_Wk7bZYb3zG4qRciOENbBSMo2TRdfdJxXzC1C5tRxav1R_dlF5SuuXKoEkJi84Ig/exec";
const DB_URL  = "https://anesaplus-default-rtdb.asia-southeast1.firebasedatabase.app";

/* ========= helpers ========= */
function $(id){ return document.getElementById(id); }
function fmt(n){ return Number(n||0).toLocaleString('th-TH'); }
function explain(err){
  const e = String(err||'').toLowerCase();
  if(e==='missing_params')    return '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö (SAP, ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•, ‡πÅ‡∏ï‡πâ‡∏°, ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô)';
  if(e==='user_not_found')    return '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö';
  if(e==='reward_not_found')  return '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•';
  if(e==='out_of_stock')      return '‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏´‡∏°‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å';
  if(e==='not_enough_points') return '‡πÅ‡∏ï‡πâ‡∏°‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠';
  return '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ ('+(err||'unknown')+')';
}

/* JSONP ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Apps Script */
function jsonp(params){
  return new Promise((resolve,reject)=>{
    const cb = "cb_"+Math.random().toString(36).slice(2);
    params = {...params, callback: cb};
    const url = GAS_URL + "?" + new URLSearchParams(params).toString();
    const s = document.createElement("script");
    const timer = setTimeout(()=>{ cleanup(); reject(new Error("timeout")); }, 15000);
    function cleanup(){ delete window[cb]; try{s.remove();}catch{} clearTimeout(timer); }
    window[cb] = (res)=>{ cleanup(); resolve(res); };
    s.onerror = ()=>{ cleanup(); reject(new Error("network_error")); };
    s.src = url; document.body.appendChild(s);
  });
}

/* ========= decode payload ‡∏à‡∏≤‡∏Å QR (‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏µ‡∏¢‡πå) ========= */
function decodePayload(){
  const first = (...xs)=> xs.find(v=> (v!==undefined && v!==null && String(v).trim()!=='')) ?? '';

  // hash: #p=base64(json)
  try{
    const hp = new URLSearchParams(location.hash.slice(1));
    const b64 = hp.get('p');
    if(b64){
      const json = decodeURIComponent(escape(window.atob(b64)));
      const o = JSON.parse(json);
      const sap    = first(o.sap, o.SAP, o.userSap, o.user, o.uid);
      const reward = first(o.rewardName, o.reward, o.rewardTitle, o.title, o.label, o.name);
      const pts    = Number(first(o.points, o.pts, o.pointsRequired, o.cost, o.needPoints, o.requiredPoints, o.required));
      const ts     = first(o.ts, o.timestamp, o.time);
      return { sap:String(sap||'').trim(), reward:String(reward||'').trim(), pts:(isNaN(pts)?0:pts), ts:String(ts||'').trim() };
    }
  }catch(_){}

  // query: ?sap=...&reward=...&points=...
  const q = new URLSearchParams(location.search);
  const sap    = first(q.get('sap'), q.get('SAP'), q.get('userSap'), q.get('user'), q.get('uid'));
  const reward = first(q.get('rewardName'), q.get('reward'), q.get('rewardTitle'), q.get('title'), q.get('label'), q.get('name'));
  const pts    = Number(first(q.get('points'), q.get('pts'), q.get('pointsRequired'), q.get('cost'), q.get('needPoints'), q.get('requiredPoints'), q.get('required')));
  const ts     = first(q.get('ts'), q.get('timestamp'), q.get('time'));
  return { sap:String(sap||'').trim(), reward:String(reward||'').trim(), pts:(isNaN(pts)?0:pts), ts:String(ts||'').trim() };
}

/* ========= RTDB: ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ========= */
async function fetchUserNameFromRTDB(sap){
  if(!sap) return null;
  try{
    const r = await fetch(`${DB_URL}/public/usersSummary/${encodeURIComponent(sap)}.json?t=${Date.now()}`, {cache:'no-store'});
    if(!r.ok) return null;
    const v = await r.json();
    if(v && typeof v==='object') return v.name || v.Name || null;
  }catch(_){}
  return null;
}

/* ========= RTDB: ‡∏î‡∏∂‡∏á‡πÅ‡∏ï‡πâ‡∏°‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ========= */
async function fetchUserPointsFromRTDB(sap){
  if(!sap) return null;
  try{
    const r = await fetch(`${DB_URL}/public/usersSummary/${encodeURIComponent(sap)}.json?t=${Date.now()}`, {cache:'no-store'});
    if(!r.ok) return null;
    const v = await r.json();
    if(v && typeof v==='object'){
      return v.pointsTotal ?? v.PointsTotal ?? v.total ?? v.balance ?? null;
    }
  }catch(_){}
  return null;
}

/* ========= RTDB: ‡∏î‡∏∂‡∏á‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ========= */
async function fetchRewardStockFromRTDB(rewardName){
  if(!rewardName) return null;
  try{
    const r = await fetch(`${DB_URL}/public/rewards/${encodeURIComponent(rewardName)}.json?t=${Date.now()}`, {cache:'no-store'});
    if(r.ok){
      const v = await r.json();
      if(v && typeof v==='object'){
        return v.stock ?? v.Stock ?? v.qty ?? v.Qty ?? null;
      }
    }
  }catch(_){}
  return null;
}

/* ========= retry helper ‡∏Å‡∏±‡∏ô‡∏î‡∏µ‡πÄ‡∏•‡∏¢‡πå ========= */
async function retry(fn, times=6, delay=250){
  for(let i=0;i<times;i++){
    const v = await fn();
    if(v !== null && v !== undefined && v !== '') return v;
    await new Promise(r=>setTimeout(r, delay));
  }
  return null;
}

/* ========= ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ï getAdmins/Admins ========= */
async function loadAdmins(){
  const sel = $("adminSelect");
  sel.innerHTML = '<option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô ‚Äî</option>';
  try{
    const res = await jsonp({ action: "getAdmins" }); // server ‡∏à‡∏∞ toLowerCase ‚Üí 'getadmins'
    const items = (res && res.items) || [];
    if(Array.isArray(items) && items.length){
      for(const it of items){
        const name = (it.name || it).toString();
        const opt = document.createElement('option');
        opt.value = (it.sap || '').toString(); // value = SAP (‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏Å‡∏ß‡πà‡∏≤)
        opt.dataset.name = name;
        opt.textContent = it.sap ? `${name} (${it.sap})` : name;
        sel.appendChild(opt);
      }
      return;
    }
  }catch(_){}
  // fallback ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏•‡∏¥‡∏™‡∏ï‡πå‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ
  sel.insertAdjacentHTML('beforeend','<option value="Tachawan">Tachawan</option>');
  sel.insertAdjacentHTML('beforeend','<option value="Dudsadee">Dudsadee</option>');
  sel.insertAdjacentHTML('beforeend','<option value="Juthawut">Juthawut</option>');
}

/* ========= ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏Å‡πÑ‡∏õ GAS ========= */
async function confirmRedeemViaGAS(payload){
  let r = await jsonp({ action:'confirmRedeem', ...payload });
  if(r && (r.ok || r.error!=='unknown_action')) return r;
  r = await jsonp({ act:'confirmRedeem', ...payload });
  if(r && (r.ok || r.error!=='unknown_action')) return r;
  r = await jsonp({ a:'confirmRedeem', ...payload });
  return r;
}

/* ========= MAIN ========= */
(async ()=>{
  const data = decodePayload();
  $("sap").textContent    = data.sap || "‚Äî";
  $("reward").textContent = data.reward || "‚Äî";
  $("points").textContent = data.pts ? fmt(data.pts) : "‚Äî";

  // ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: RTDB ‚Üí fallback GAS
  let userName = await fetchUserNameFromRTDB(data.sap);
  if(!userName){
    try{
      const r = await jsonp({ action:'userstatus', sap:data.sap });
      userName = (r && r.name) || null;
    }catch(_){}
  }
  $("userName").textContent = userName || "‚Äî";

  await loadAdmins();

  // sync input ‡∏Å‡∏±‡∏ö select
  $("adminSelect").addEventListener("change", e=>{
    const sel = e.target;
    const sap = (sel.value || "").trim();
    const opt = sel.options[sel.selectedIndex];
    const name = (opt && opt.dataset && opt.dataset.name) ? String(opt.dataset.name) : "";
    if(sap){
      $("adminSAP").value = sap;
      if(name) $("adminName").value = name;
    }
  });

  let locking = false;

  $("btnConfirm").addEventListener("click", async ()=>{
    if(locking) return;
    const msg = $("msg");
    msg.className = "mt hint";

    if(!data.sap || !data.reward || !data.pts){
      msg.textContent = "‚ùå ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏à‡∏≤‡∏Å QR"; return;
    }
    const adminNameInput = $("adminName").value.trim();
    const adminSAP = $("adminSAP").value.trim() || $("adminSelect").value.trim();
    const opt = $("adminSelect").options[$("adminSelect").selectedIndex];
    const adminNameAuto = (opt && opt.dataset && opt.dataset.name) ? String(opt.dataset.name).trim() : "";
    const adminName = adminNameInput || adminNameAuto;
    if(!adminName && !adminSAP){ msg.textContent = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å/‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô"; $("adminName").focus(); return; }

    // disable ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (‡∏Å‡∏±‡∏ô‡πÄ‡∏ú‡∏•‡∏≠‡∏Å‡∏î‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å)
    $("btnConfirm").disabled = true;
    $("btnCancel").disabled  = true;
    locking = true;
    msg.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‚Ä¶";

    try{
      const res = await confirmRedeemViaGAS({
        sap: data.sap,
        rewardName: data.reward,
        points: data.pts,
        adminName,
        adminSAP,
        ts: data.ts
      });

      if(res && res.ok){
        // 1) ‡∏ñ‡πâ‡∏≤ GAS ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏Å‡πá‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏¢
        let totalAfter = (res && ('totalAfter' in res)) ? res.totalAfter : null;
        let stockAfter = (res && ('stockAfter' in res)) ? res.stockAfter : null;

        // 2) ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ ‚Üí ‡πÑ‡∏õ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å RTDB (‡πÑ‡∏°‡πà‡πÅ‡∏ï‡∏∞ Apps Script)
        if(totalAfter === null || totalAfter === undefined){
          totalAfter = await retry(()=>fetchUserPointsFromRTDB(data.sap));
        }
        if(stockAfter === null || stockAfter === undefined){
          stockAfter = await retry(()=>fetchRewardStockFromRTDB(data.reward));
        }

        const afterTotalTxt = (totalAfter===null || totalAfter===undefined) ? '‚Äî' : fmt(totalAfter);
        const afterStockTxt = (stockAfter===null || stockAfter===undefined) ? '‚Äî' : fmt(stockAfter);

        msg.className = "mt ok";
        msg.innerHTML = `‚úÖ ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à<br>
        ‡πÅ‡∏ï‡πâ‡∏°‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: <b>${afterTotalTxt}</b> | ‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: <b>${afterStockTxt}</b>`;

        // üîí ‡∏•‡πá‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ‡∏ï‡πâ‡∏≠‡∏á‡∏™‡πÅ‡∏Å‡∏ô QR ‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
        $("btnConfirm").disabled = true;
        $("btnCancel").disabled  = true;
        $("adminName").disabled  = true;
        $("adminSelect").disabled = true;
        locking = true;

      }else{
        // fail ‚Üí ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ
        $("btnConfirm").disabled = false;
        $("btnCancel").disabled  = false;
        locking = false;
        msg.className = "mt err";
        msg.textContent = "‚ùå " + explain(res && res.error);
      }
    }catch(e){
      $("btnConfirm").disabled = false;
      $("btnCancel").disabled  = false;
      locking = false;
      msg.className = "mt err";
      msg.textContent = "‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠";
    }
  });

  $("btnCancel").addEventListener("click", ()=>history.back());
})();
</script>
</body>
</html>
