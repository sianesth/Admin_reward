<!doctype html>
<html lang="th">
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Admin ‚Äî ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å</title>
<style>
  :root{--line:#e6e9f2;--txt:#0f1733;--muted:#6b78a6;--brand:#1f6fff;--bg:#f6f8fd;--card:#fff}
  *{box-sizing:border-box}
  body{font:15px/1.6 system-ui,Segoe UI,Inter;margin:0;background:var(--bg);color:var(--txt)}
  .card{max-width:720px;margin:24px auto;background:var(--card);border:1px solid var(--line);border-radius:12px;padding:16px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  select,button{border-radius:10px;border:1px solid var(--line);padding:9px 12px;font:inherit}
  button{cursor:pointer;background:var(--brand);color:#fff;border-color:transparent}
  button[disabled]{opacity:.7;cursor:not-allowed}
  .muted{color:var(--muted)}
  .kv{display:grid;grid-template-columns:140px 1fr;gap:8px 12px}
  .kv div:nth-child(odd){color:var(--muted)}
  .ok{color:#0a8d4c}.bad{color:#d93025}
  .note{font-size:12px;margin-top:6px}
</style>

<body>
  <div class="card">
    <h2>‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å (Admin)</h2>
    <div id="info" class="muted">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</div>
    <div class="note muted" id="ver">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‚Ä¶</div>

    <div id="detail" style="margin-top:12px" class="kv">
      <div>SAP</div><div id="sap">‚Äî</div>
      <div>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÅ‡∏•‡∏Å</div><div id="name" class="muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á...</div>
      <div>‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</div><div id="reward">‚Äî</div>
      <div>‡πÅ‡∏ï‡πâ‡∏°‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ</div><div id="points">‚Äî</div>
    </div>

    <div class="row" style="margin-top:14px">
      <label for="adminSel" class="muted">‡∏£‡∏±‡∏ö‡πÅ‡∏•‡∏Å‡πÇ‡∏î‡∏¢</label>
      <select id="adminSel" style="min-width:220px">
        <option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô ‚Äî</option>
      </select>
      <button id="btnConfirm">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å</button>
    </div>

    <div id="status" class="muted" style="margin-top:10px"></div>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";

/* ===== CONFIG ===== */
const firebaseConfig = {
  apiKey: "AIzaSyCMTpAce-Q-fTkS7xDDYuEpPwgtBIrDP04",
  authDomain: "anespoint-bfd3d.firebaseapp.com",
  databaseURL: "https://anespoint-bfd3d-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "anespoint-bfd3d",
  appId: "1:1234567890:web:abcdef123456"
};
// üëâ ‡πÉ‡∏™‡πà URL Deploy ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á Apps Script (‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢ /exec ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)
const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbzAawZ3sMTGNnxzhr5t2QTZMYQgGCBcvfCS8QqL-MbBGCyFpEnvHqRPrYXM3t0o5fSf5A/exec";

const app = initializeApp(firebaseConfig);
const db  = getDatabase(app);

const $ = q => document.querySelector(q);
const fmt = n => Number(n||0).toLocaleString('th-TH');

/* ===== JSONP helper (‡∏û‡∏£‡πâ‡∏≠‡∏° timeout) ===== */
function api(body, timeoutMs=15000){
  return new Promise((resolve,reject)=>{
    const cb='cb_'+Math.random().toString(36).slice(2);
    let settled=false, timer=null;
    window[cb]=d=>{ if(settled) return; settled=true; clearTimeout(timer); resolve(d); cleanup(); };
    const qs=new URLSearchParams({...body,callback:cb}).toString();
    const s=document.createElement('script');
    function cleanup(){ try{ delete window[cb]; }catch{} s.remove(); }
    s.src=`${GAS_ENDPOINT}?${qs}`;
    s.onerror=()=>{ if(settled) return; settled=true; clearTimeout(timer); reject(new Error('GAS network error')); cleanup(); };
    document.body.appendChild(s);
    timer=setTimeout(()=>{ if(settled) return; settled=true; reject(new Error('GAS timeout')); cleanup(); }, timeoutMs);
  });
}

/* ===== payload ‡∏à‡∏≤‡∏Å QR ===== */
function decodePayload(){
  try{
    const params=new URLSearchParams(location.hash.slice(1));
    const b64=params.get('p'); if(!b64) return null;
    const json=decodeURIComponent(escape(window.atob(b64)));
    return JSON.parse(json);
  }catch(e){ return null; }
}

/* ===== ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô ===== */
async function loadAdmins(){
  const sel = $('#adminSel');
  sel.innerHTML = '<option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô ‚Äî</option>';
  let list = null;
  try{
    const r = await api({action:'getAdmins'});
    if(r && r.ok && Array.isArray(r.items) && r.items.length){ list = r.items; }
  }catch(_){}
  if(!list){ list = ['‡∏î‡∏∏‡∏©‡∏é‡∏µ  ‡∏≠‡∏£‡∏£‡∏à‡∏ô‡πå‡∏≠‡∏±‡∏á‡∏Å‡∏π‡∏£','‡∏à‡∏∏‡∏ë‡∏≤‡∏ß‡∏∏‡∏í‡∏¥  ‡∏≠‡∏∏‡πà‡∏ô‡∏≠‡∏°‡∏£‡∏°‡∏≤‡∏®','ANES-Front']; }
  list.forEach(name=>{
    const opt=document.createElement('option');
    opt.value=name; opt.textContent=name; sel.appendChild(opt);
  });
}

/* ===== ‡∏ï‡∏£‡∏ß‡∏à version ‡∏Ç‡∏≠‡∏á‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á ===== */
async function checkVersion(){
  try{
    const r = await api({action:'version'});
    if(r && r.ok){
      $('#ver').textContent = `‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${r.version || 'unknown'} @ ${r.time || ''}`;
    }else{
      $('#ver').textContent = '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
    }
  }catch(e){
    $('#ver').textContent = '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
  }
}

/* ===== main ===== */
const data = decodePayload();
if(!data){
  $('#status').textContent = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å QR';
}else{
  $('#sap').textContent    = data.sap || '‚Äî';
  $('#reward').textContent = data.reward || '‚Äî';
  $('#points').textContent = fmt(data.pts || 0);
  try{
    const snap = await get(ref(db, 'public/usersSummary/'+data.sap));
    const v = snap.exists() ? snap.val() : {};
    $('#name').textContent = v.name || '(‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö)';
    if(!snap.exists()){ $('#name').classList.add('bad'); } else { $('#name').classList.add('ok'); }
  }catch(e){
    $('#name').textContent = '(‡∏≠‡πà‡∏≤‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à)'; $('#name').classList.add('bad');
  }
}
await checkVersion();
await loadAdmins();

/* ===== ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å (‡∏Å‡∏±‡∏ô‡∏î‡∏±‡∏ö‡πÄ‡∏ö‡∏¥‡∏•‡∏Ñ‡∏•‡∏¥‡∏Å + ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ä‡∏±‡∏î) ===== */
let confirming=false;
async function confirmRedeem(payload){
  let r = await api({action:'confirmRedeem', ...payload}).catch(()=>null);
  if(r && (r.ok || r.error!=='unknown_action')) return r;
  r = await api({act:'confirmRedeem', ...payload}).catch(()=>null);
  if(r && (r.ok || r.error!=='unknown_action')) return r;
  r = await api({a:'confirmRedeem', ...payload}).catch(()=>null);
  return r;
}
$('#btnConfirm').onclick = async()=>{
  if(!data || confirming) return;
  const admin = $('#adminSel').value.trim();
  if(!admin){ $('#status').textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô'; return; }
  confirming=true;
  const btn=$('#btnConfirm'); const sel=$('#adminSel');
  btn.disabled=true; sel.disabled=true;
  $('#status').textContent='‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô...';
  try{
    const payload = { sap:data.sap, rewardName:data.reward, admin, ts:data.ts, points:data.pts };
    const r = await confirmRedeem(payload);
    if(r && r.ok){
      $('#status').innerHTML = `‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úì | ‡πÅ‡∏ï‡πâ‡∏°‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: <b>${fmt(r.totalAfter)}</b> | ‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: <b>${fmt(r.stockAfter)}</b>`;
      $('#status').classList.remove('bad'); $('#status').classList.add('ok');
    }else{
      const extra = r && (r.received || (r.echo ? JSON.stringify(r.echo) : ""));
      $('#status').textContent = '‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (r && r.error ? r.error : '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î') + (extra ? ` (${extra})` : '');
      $('#status').classList.remove('ok'); $('#status').classList.add('bad');
      btn.disabled=false; sel.disabled=false; confirming=false; return;
    }
  }catch(e){
    $('#status').textContent = '‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (e && e.message ? e.message : '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
    $('#status').classList.remove('ok'); $('#status').classList.add('bad');
    btn.disabled=false; sel.disabled=false; confirming=false; return;
  }
  // ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß‡∏õ‡∏•‡πà‡∏≠‡∏¢ disabled ‡πÑ‡∏ß‡πâ
};
</script>
</body>
</html>
