<!doctype html>
<html lang="th">
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Admin ‚Äî ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å</title>
<style>
  :root{--line:#e6e9f2;--txt:#0f1733;--muted:#6b78a6;--brand:#1f6fff;--bg:#f6f8fd;--card:#fff}
  *{box-sizing:border-box}
  body{font:15px/1.6 system-ui,Segoe UI,Inter;margin:0;background:var(--bg);color:var(--txt)}
  .card{max-width:720px;margin:24px auto;background:var(--card);border:1px solid var(--line);border-radius:12px;padding:16px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  select,button{border-radius:10px;border:1px solid var(--line);padding:9px 12px;font:inherit}
  button{cursor:pointer;background:var(--brand);color:#fff;border-color:transparent}
  .muted{color:var(--muted)}
  .kv{display:grid;grid-template-columns:140px 1fr;gap:8px 12px}
  .kv div:nth-child(odd){color:var(--muted)}
  .ok{color:#0a8d4c}.bad{color:#d93025}
  .note{font-size:12px;margin-top:6px}

body{
  font-family: "Sarabun", system-ui, -apple-system, "Segoe UI", Inter, sans-serif;
  background: var(--bg);
  color: var(--txt);
}
h2{
  font-weight: 700;
  font-size: 20px;
  color: #0f1733;
  margin-top: 0;
}
.card{
  box-shadow: 0 4px 18px rgba(0,0,0,.05);
}
button{
  transition: background .2s, transform .1s;
}
button:hover{ filter: brightness(1.05); }
button:active{ transform: translateY(1px); }

<style>
  /* ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ó‡∏ô‡∏ï‡πå‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠ ‡πÅ‡∏•‡∏∞‡∏™‡∏π‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏ó‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ */
  html, body { height: 100%; }
  body { margin: 0; background:#f6f8fd; }

  /* ‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ó‡∏ô‡∏ï‡πå‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏´‡πâ‡∏Å‡∏ß‡πâ‡∏≤‡∏á 100% ‡πÑ‡∏°‡πà‡∏à‡∏≥‡∏Å‡∏±‡∏î max-width */
  main, .wrap, .container, .page, .content {
    max-width: none !important;
    width: 100% !important;
  }

  /* ‡πÄ‡∏ß‡πâ‡∏ô‡∏£‡∏∞‡∏¢‡∏∞‡∏£‡∏≠‡∏ö ‡πÜ ‡πÉ‡∏´‡πâ‡∏î‡∏π‡πÇ‡∏õ‡∏£‡πà‡∏á ‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡πâ‡∏™‡∏π‡∏á‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥‡πÄ‡∏ï‡πá‡∏° viewport */
  main, .wrap, .page, .content {
    padding: 20px clamp(14px, 4vw, 28px) 28px;
    min-height: 100vh;               /* ‡∏™‡∏π‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠ */
    box-sizing: border-box;
  }

  /* ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÉ‡∏´‡πâ‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏ï‡πá‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á */
  .card, .panel, .box {
    width: 100%;
    border-radius: 16px;
    border: 1px solid #e9eef7;
    box-shadow: 0 8px 24px rgba(15,23,51,.06);
  }
</style>

<body>
  <div class="card">
    <h2>‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å (Admin)</h2>
    <div id="info" class="muted">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</div>
    <div class="note muted" id="ver">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‚Ä¶</div>

    <div id="detail" style="margin-top:12px" class="kv">
      <div>SAP</div><div id="sap">‚Äî</div>
      <div>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÅ‡∏•‡∏Å</div><div id="name" class="muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á...</div>
      <div>‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</div><div id="reward">‚Äî</div>
      <div>‡πÅ‡∏ï‡πâ‡∏°‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ</div><div id="points">‚Äî</div>
    </div>

    <div class="row" style="margin-top:14px; align-items:center; gap:10px">
        <label for="adminSap" class="muted">‡∏£‡∏±‡∏ö‡πÅ‡∏•‡∏Å‡πÇ‡∏î‡∏¢ (SAP ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô)</label>
        <input id="adminSap" inputmode="numeric" pattern="[0-9]{4,}" placeholder="‡πÄ‡∏ä‡πà‡∏ô 600000"
               style="min-width:220px;padding:8px 10px;border:1px solid #dbe2f1;border-radius:10px">
        <small id="adminNameHint" class="muted" style="min-width:180px;"></small>
        <button id="btnConfirm">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å</button>
      </div>

    <div id="status" class="muted" style="margin-top:10px"></div>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";

/* ===== CONFIG ===== */
const firebaseConfig = {
  apiKey: "AIzaSyAiSW2d16RpHjtUR7OIl2PVpvH_QPL3cp4",
  authDomain: "anesaplus.firebaseapp.com",
  databaseURL: "ttps://anesaplus-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "anesaplus",
  appId: "1:518123966097:web:2f93eeb56ec026aa903930"
};
// üëâ ‡πÉ‡∏ä‡πâ Web App (Deployment ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î) ‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢ /exec
const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbwPOW_Wk7bZYb3zG4qRciOENbBSMo2TRdfdJxXzC1C5tRxav1R_dlF5SuuXKoEkJi84Ig/exec";

const app = initializeApp(firebaseConfig);
const db  = getDatabase(app);

const $   = (q)=>document.querySelector(q);
const fmt = (n)=>Number(n||0).toLocaleString('th-TH');

/* ===== JSONP helper (GAS) ===== */
function api(body){
  return new Promise((resolve,reject)=>{
    const cb='cb_'+Math.random().toString(36).slice(2);
    window[cb]=d=>{ resolve(d); delete window[cb]; s.remove(); };
    const qs=new URLSearchParams({...body,callback:cb}).toString();
    const s=document.createElement('script');
    s.src=`${GAS_ENDPOINT}?${qs}`;
    s.onerror=()=>reject(new Error('GAS error'));
    document.body.appendChild(s);
  });
}

/* ===== Decode payload ‡∏à‡∏≤‡∏Å QR (hash #p=...) ===== */
function decodePayload(){
  try{
    const params=new URLSearchParams(location.hash.slice(1));
    const b64=params.get('p'); if(!b64) return null;
    const json=decodeURIComponent(escape(window.atob(b64)));
    return JSON.parse(json);
  }catch(e){ return null; }
}

/* ===== ‡∏ï‡∏£‡∏ß‡∏à version ‡∏Ç‡∏≠‡∏á‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á (‡∏Å‡∏±‡∏ô‡∏¢‡∏¥‡∏á‡∏ú‡∏¥‡∏î‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå) ===== */
async function checkVersion(){
  const el = $('#ver');
  try{
    const r = await api({action:'version'});
    el.textContent = (r && r.ok) ? '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•' : '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Apps Script ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
  }catch{ el.textContent = '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Apps Script ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'; }
}

/* ===== ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏à‡∏≤‡∏Å Google Sheet (action: verifyAdmin) ===== */
async function verifyAdminBySAP(adminSAP){
  try{
    const r = await api({action:'verifyAdmin', sap: adminSAP});
    if(r && r.ok && r.adminName) return r.adminName;
  }catch(_){}
  return null;
}

/* ===== ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏≠‡∏Å SAP ===== */
let _admTimer = null;
$('#adminSap').addEventListener('input', (e)=>{
  e.target.value = (e.target.value||'').replace(/\D/g,'');  // ‡∏£‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
  const sap = e.target.value;
  const hint = $('#adminNameHint');
  hint.textContent = '';
  hint.style.color = '';

  if (sap.length < 4){
    if (sap.length){ hint.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 8 ‡∏´‡∏•‡∏±‡∏Å'; hint.style.color = '#6b78a6'; }
    return;
  }
  clearTimeout(_admTimer);
  _admTimer = setTimeout(async ()=>{
    hint.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...'; hint.style.color = '#6b78a6';
    const name = await verifyAdminBySAP(sap);
    if (name){ hint.textContent = `‚úì ${name}`; hint.style.color = '#0a8c4a'; }
    else { hint.textContent = '‚úó ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô'; hint.style.color = '#d93025'; }
  }, 250);
});

/* ===== ‡∏Å‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å ===== */
$('#btnConfirm').addEventListener('click', async ()=>{
  const statusEl = $('#status');
  statusEl.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...';

  const adminSAP = ($('#adminSap').value||'').trim();
  if(!/^\d{4,}$/.test(adminSAP)){
    statusEl.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å SAP ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
    return;
  }

  const payload = decodePayload();
  if(!payload){ statusEl.textContent = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å QR'; return; }

  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô
  const adminName = await verifyAdminBySAP(adminSAP);
  if(!adminName){ statusEl.textContent = 'SAP ‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï'; return; }

  // ‡∏¢‡∏¥‡∏á‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å ‚Üí GAS ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô Redemptions + ‡∏´‡∏±‡∏Å‡πÅ‡∏ï‡πâ‡∏°
  statusEl.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å...';
  try{
    const r = await api({
      action:'confirmRedeem',
      sap: payload.sap,
      reward: payload.reward,
      points: payload.pts,
      adminSAP: adminSAP
    });
    if(r && r.ok){
      statusEl.textContent = `‡πÅ‡∏•‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÇ‡∏î‡∏¢ ${adminName}`;
    }else{
      statusEl.textContent = r && r.error ? r.error : '‡πÅ‡∏•‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
    }
  }catch(e){
    statusEl.textContent = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠';
  }
});

/* ===== main/init ===== */
(async function init(){
  const data = decodePayload();
  if(!data){
    $('#status').textContent = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å QR';
    return;
  }
  $('#sap').textContent    = data.sap || '‚Äî';
  $('#reward').textContent = data.reward || '‚Äî';
  $('#points').textContent = fmt(data.pts || 0);

  // ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏à‡∏≤‡∏Å RTDB
  try{
    const snap = await get(ref(db, 'public/usersSummary/'+(data.sap||'')));
    const v = snap.exists() ? snap.val() : {};
    $('#name').textContent = v.name || '(‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö)';
    $('#name').classList.add(snap.exists() ? 'ok' : 'bad');
  }catch{
    $('#name').textContent = '(‡∏≠‡πà‡∏≤‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à)';
    $('#name').classList.add('bad');
  }

  await checkVersion();
})();
</script>

</head>
</body>
</html>
