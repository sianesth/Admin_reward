<!doctype html>
<html lang="th">
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Admin — ยืนยันการแลก</title>
<style>
  :root{--line:#e6e9f2;--txt:#0f1733;--muted:#6b78a6;--brand:#1f6fff;--bg:#f6f8fd;--card:#fff}
  *{box-sizing:border-box}
  body{font:15px/1.6 system-ui,Segoe UI,Inter;margin:0;background:var(--bg);color:var(--txt)}
  .card{max-width:720px;margin:24px auto;background:var(--card);border:1px solid var(--line);border-radius:12px;padding:16px;box-shadow:0 4px 18px rgba(0,0,0,.05)}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  select,button{border-radius:10px;border:1px solid var(--line);padding:9px 12px;font:inherit}
  button{cursor:pointer;background:var(--brand);color:#fff;border-color:transparent;transition:background .2s,transform .1s}
  button:hover{filter:brightness(1.05)} button:active{transform:translateY(1px)}
  .muted{color:var(--muted)}
  .kv{display:grid;grid-template-columns:140px 1fr;gap:8px 12px}
  .kv div:nth-child(odd){color:var(--muted)}
  .ok{color:#0a8d4c}.bad{color:#d93025}
</style>

<body>
  <div class="card">
    <h2>✅ ยืนยันการแลก (Admin)</h2>
    <div id="info" class="muted">ตรวจสอบข้อมูลการแลกรางวัลให้ถูกต้อง</div>
    <div class="muted" id="ver" style="font-size:12px;margin-top:6px">เชื่อมต่อ…</div>

    <div id="detail" style="margin-top:12px" class="kv">
      <div>SAP</div><div id="sap">—</div>
      <div>ชื่อผู้แลก</div><div id="name" class="muted">กำลังดึง...</div>
      <div>รางวัล</div><div id="reward">—</div>
      <div>แต้มที่ใช้</div><div id="points">—</div>
    </div>

    <div class="row" style="margin-top:14px">
      <label for="adminSelect" class="muted">รับแลกโดย (เลือกแอดมิน)</label>
      <select id="adminSelect" style="min-width:260px">
        <option value="">กำลังโหลดรายชื่อแอดมิน…</option>
      </select>
      <small id="adminHint" class="muted"></small>
      <button id="btnConfirm">ยืนยันการแลก</button>
    </div>

    <div id="status" class="muted" style="margin-top:10px"></div>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";

/* ===== CONFIG ===== */
const firebaseConfig = {
  apiKey: "AIzaSyAiSW2d16RpHjtUR7OIl2PVpvH_QPL3cp4",
  authDomain: "anesaplus.firebaseapp.com",
  // ⚠️ แก้ให้มี h ตรง https
  databaseURL: "https://anesaplus-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "anesaplus",
  appId: "1:518123966097:web:2f93eeb56ec026aa903930"
};
// ใช้ Deployment ล่าสุด (ลงท้าย /exec)
const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbwPOW_Wk7bZYb3zG4qRciOENbBSMo2TRdfdJxXzC1C5tRxav1R_dlF5SuuXKoEkJi84Ig/exec";

const app = initializeApp(firebaseConfig);
const db  = getDatabase(app);

const $ = (q)=>document.querySelector(q);
const fmt = (n)=>Number(n||0).toLocaleString('th-TH');

/* ===== JSONP helper ===== */
function api(body){
  return new Promise((resolve,reject)=>{
    const cb='cb_'+Math.random().toString(36).slice(2);
    window[cb]=d=>{ resolve(d); delete window[cb]; s.remove(); };
    const qs=new URLSearchParams({...body,callback:cb}).toString();
    const s=document.createElement('script');
    s.src=`${GAS_ENDPOINT}?${qs}`;
    s.onerror=()=>reject(new Error('GAS error'));
    document.body.appendChild(s);
  });
}

/* ===== payload จาก QR (#p=...) ===== */
function decodePayload(){
  try{
    const params=new URLSearchParams(location.hash.slice(1));
    const b64=params.get('p'); if(!b64) return null;
    const json=decodeURIComponent(escape(window.atob(b64)));
    return JSON.parse(json);
  }catch{ return null; }
}

/* ===== version ping ===== */
async function checkVersion(){
  const el = $('#ver');
  try{
    const r = await api({action:'version'});
    el.textContent = (r && r.ok) ? 'เชื่อมต่อฐานข้อมูล' : 'เชื่อมต่อ Apps Script ไม่สำเร็จ';
  }catch{ el.textContent = 'เชื่อมต่อ Apps Script ไม่สำเร็จ'; }
}

/* ===== โหลดรายชื่อแอดมิน (dropdown) ===== */
async function loadAdmins(){
  const sel = $('#adminSelect');
  try{
    const r = await api({action:'getadmins'});
    const items = (r && r.ok && Array.isArray(r.items)) ? r.items : [];
    if (!items.length){
      sel.innerHTML = '<option value="">ไม่พบรายชื่อแอดมิน</option>';
      return;
    }
    sel.innerHTML = '<option value="">— เลือกแอดมิน —</option>' +
      items.map(x => `<option value="${(x.sap||'').trim()}">${(x.name||'').trim()} (${(x.sap||'').trim()})</option>`).join('');
  }catch{
    sel.innerHTML = '<option value="">โหลดรายชื่อแอดมินไม่สำเร็จ</option>';
  }
}

/* ===== กดยืนยันการแลก ===== */
$('#btnConfirm').addEventListener('click', async ()=>{
  const statusEl = $('#status');
  statusEl.textContent = 'กำลังตรวจสอบ...';

  const adminSAP = ($('#adminSelect').value||'').trim();
  const adminText = $('#adminSelect').selectedOptions[0]?.textContent || '';
  if(!adminSAP){
    statusEl.textContent = 'กรุณาเลือกแอดมิน';
    return;
  }

  const payload = decodePayload();
  if(!payload){ statusEl.textContent = 'ไม่พบข้อมูลจาก QR'; return; }

  // ยิงยืนยันการแลก
  statusEl.textContent = 'กำลังบันทึกการแลก...';
  try{
    const r = await api({
      action:'confirmredeem',
      sap: payload.sap,
      reward: payload.reward,
      points: payload.pts,
      adminSAP: adminSAP
    });
    if(r && r.ok){
      statusEl.textContent = `แลกสำเร็จ โดย ${adminText}`;
    }else{
      statusEl.textContent = r && r.error ? r.error : 'แลกไม่สำเร็จ';
    }
  }catch{
    statusEl.textContent = 'เกิดข้อผิดพลาดในการเชื่อมต่อ';
  }
});

/* ===== main ===== */
(async function init(){
  const data = decodePayload();
  if(!data){ $('#status').textContent = 'ไม่พบข้อมูลจาก QR'; return; }
  $('#sap').textContent    = data.sap || '—';
  $('#reward').textContent = data.reward || '—';
  $('#points').textContent = fmt(data.pts || 0);

  // ชื่อผู้ใช้จาก RTDB
  try{
    const snap = await get(ref(db, 'public/usersSummary/'+(data.sap||'')));
    const v = snap.exists() ? snap.val() : {};
    $('#name').textContent = v.name || '(ไม่พบชื่อในระบบ)';
    $('#name').classList.add(snap.exists() ? 'ok' : 'bad');
  }catch{
    $('#name').textContent = '(อ่านชื่อไม่สำเร็จ)';
    $('#name').classList.add('bad');
  }

  await checkVersion();
  await loadAdmins();
})();
</script>
</body>
</html>
