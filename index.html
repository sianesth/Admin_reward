<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>ยืนยันการแลก (Admin)</title>
<style>
  :root{ --bg:#f6f8fd;--card:#fff;--line:#e6e9f2;--txt:#0f1733;--muted:#6b78a6;--ok:#0a8c4a;--danger:#d93025;--btn:#1f6fff;}
  body{margin:0;background:var(--bg);font:16px/1.6 system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial,sans-serif;color:var(--txt);}
  .wrap{max-width:620px;margin:24px auto;padding:16px;}
  .card{background:#fff;border:1px solid var(--line);border-radius:14px;box-shadow:0 10px 30px rgba(15,23,51,.06);padding:20px;}
  h1{margin:0 0 8px;font-size:22px}
  .row{display:flex;gap:12px;align-items:center;margin:10px 0}
  .key{width:140px;color:var(--muted)}
  input,select,button{font:inherit;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff}
  input,select{flex:1}
  .btn{background:var(--btn);color:#fff;border:none;cursor:pointer}
  .btn[disabled]{opacity:.5;cursor:not-allowed}
  .hint{color:var(--muted);font-size:13px}
  .ok{color:var(--ok)} .err{color:var(--danger)}
  .pill{display:inline-block;background:#eef3ff;border:1px solid #dfe7ff;padding:4px 10px;border-radius:999px;font-size:13px}
  .mt{margin-top:16px}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>✅ ยืนยันการแลก (Admin)</h1>
    <p class="hint">ตรวจสอบข้อมูลการแลกรางวัลให้ถูกต้อง</p>

    <div class="row"><div class="key">SAP</div><div id="sap" class="pill">—</div></div>
    <div class="row"><div class="key">ชื่อผู้แลก</div><div id="userName" class="pill">กำลังดึง…</div></div>
    <div class="row"><div class="key">รางวัล</div><div id="reward" class="pill">—</div></div>
    <div class="row"><div class="key">แต้มที่ใช้</div><div id="points" class="pill">—</div></div>

    <div class="row mt">
      <div class="key">รับแลกโดย</div>
      <input id="adminName" placeholder="ชื่อจริง เช่น จุฑาวุฒิ">
    </div>
    <div class="row">
      <div class="key">หรือเลือก</div>
      <select id="adminSelect"><option value="">— โหลดรายชื่อแอดมิน… —</option></select>
    </div>

    <div class="row mt">
      <button id="btnConfirm" class="btn">ยืนยันแลก</button>
      <button id="btnCancel" type="button">ยกเลิก</button>
    </div>

    <p id="msg" class="mt hint"></p>
  </div>
</div>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbwPOW_Wk7bZYb3zG4qRciOENbBSMo2TRdfdJxXzC1C5tRxav1R_dlF5SuuXKoEkJi84Ig/exec";
const qs = new URLSearchParams(location.search);
function $(id){ return document.getElementById(id); }

// ---------- JSONP helper ----------
function jsonp(params){
  return new Promise((resolve,reject)=>{
    const cb = "cb_"+Math.random().toString(36).slice(2);
    params.callback = cb;
    const url = GAS_URL + "?" + new URLSearchParams(params).toString();
    const s = document.createElement("script");
    const timer = setTimeout(()=>{ cleanup(); reject(new Error("timeout")); }, 15000);
    function cleanup(){ delete window[cb]; s.remove(); clearTimeout(timer); }
    window[cb] = (res)=>{ cleanup(); resolve(res); };
    s.onerror = ()=>{ cleanup(); reject(new Error("network_error")); };
    s.src = url; document.body.appendChild(s);
  });
}

// ---------- อ่าน params จาก QR ----------
const sap    = (qs.get("sap")||"").trim();
const reward = (qs.get("rewardName")||qs.get("reward")||"").trim();
const points = Number(qs.get("points")||qs.get("pts")||0);
const ts     = (qs.get("ts")||"").trim();

$("sap").textContent = sap || "—";
$("reward").textContent = reward || "—";
$("points").textContent = points || "—";

// ---------- โหลดรายชื่อแอดมิน ----------
jsonp({ action:"getadmins" }).then(res=>{
  const sel = $("adminSelect");
  sel.innerHTML = '<option value="">— เลือกชื่อแอดมิน —</option>';
  (res.items||[]).forEach(it=>{
    const opt = document.createElement("option");
    opt.value = it.name;
    opt.textContent = it.name + " (" + it.sap + ")";
    sel.appendChild(opt);
  });
}).catch(()=>{ $("adminSelect").innerHTML = '<option value="">— ไม่พบรายชื่อ —</option>'; });

$("adminSelect").addEventListener("change", e=>{
  if(e.target.value) $("adminName").value = e.target.value;
});

// ---------- ดึงชื่อผู้ใช้ ----------
if(sap){
  jsonp({ action:"userstatus", sap }).then(res=>{
    $("userName").textContent = res && res.name ? res.name : "—";
  }).catch(()=>{ $("userName").textContent = "—"; });
}

// ---------- ฟังก์ชันอธิบาย error ----------
function explain(err){
  switch(String(err||'').toLowerCase()){
    case 'missing_params': return 'ข้อมูลไม่ครบ (SAP, รางวัล, แต้ม, แอดมิน)';
    case 'user_not_found': return 'ไม่พบผู้ใช้ในระบบ';
    case 'reward_not_found': return 'ไม่พบชื่อรางวัล';
    case 'out_of_stock': return 'ของรางวัลหมดสต็อก';
    case 'not_enough_points': return 'แต้มไม่เพียงพอ';
    default: return 'ไม่สามารถบันทึกได้ ('+(err||'unknown')+')';
  }
}

// ---------- ยืนยันแลก ----------
let locking = false;
$("btnConfirm").addEventListener("click", async ()=>{
  if(locking) return;
  const adminName = $("adminName").value.trim();
  const msg = $("msg");
  msg.className = "mt hint";
  if(!sap || !reward || !points){ msg.textContent = "❌ ข้อมูลไม่ครบจาก QR"; return; }
  if(!adminName){ msg.textContent = "กรุณาพิมพ์ชื่อแอดมิน"; $("adminName").focus(); return; }

  $("btnConfirm").disabled = true;
  locking = true;
  msg.textContent = "กำลังบันทึก…";

  try{
    const res = await jsonp({ action:"confirmredeem", sap, rewardName:reward, points, adminName, ts });
    if(res && res.ok){
      msg.className = "mt ok";
      msg.textContent = "✅ บันทึกสำเร็จ — หน้านี้จะปิดอัตโนมัติ";
      setTimeout(()=>window.close(),1500);
    }else{
      msg.className = "mt err";
      msg.textContent = "❌ " + explain(res && res.error);
      $("btnConfirm").disabled = false;
      locking = false;
    }
  }catch(err){
    msg.className = "mt err"; msg.textContent = "❌ เกิดข้อผิดพลาดในการเชื่อมต่อ";
    $("btnConfirm").disabled = false;
    locking = false;
  }
});

$("btnCancel").addEventListener("click", ()=>history.back());
</script>
</body>
</html>
