<!doctype html>
<html lang="th">
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Admin — ยืนยันการแลก</title>
<style>
  :root{--line:#e6e9f2;--txt:#0f1733;--muted:#6b78a6;--brand:#1f6fff;--bg:#f6f8fd;--card:#fff}
  *{box-sizing:border-box}
  body{font:15px/1.6 system-ui,Segoe UI,Inter;margin:0;background:var(--bg);color:var(--txt)}
  .card{max-width:720px;margin:24px auto;background:var(--card);border:1px solid var(--line);border-radius:12px;padding:16px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  select,button{border-radius:10px;border:1px solid var(--line);padding:9px 12px;font:inherit}
  button{cursor:pointer;background:var(--brand);color:#fff;border-color:transparent}
  .muted{color:var(--muted)}
  .kv{display:grid;grid-template-columns:140px 1fr;gap:8px 12px}
  .kv div:nth-child(odd){color:var(--muted)}
  .ok{color:#0a8d4c}.bad{color:#d93025}
</style>

<body>
  <div class="card">
    <h2>✅ ยืนยันการแลก (Admin)</h2>
    <div id="info" class="muted">ตรวจสอบข้อมูลการแลกรางวัลให้ถูกต้อง</div>

    <div id="detail" style="margin-top:12px" class="kv">
      <div>SAP</div><div id="sap">—</div>
      <div>ชื่อผู้แลก</div><div id="name" class="muted">กำลังดึง...</div>
      <div>รางวัล</div><div id="reward">—</div>
      <div>แต้มที่ใช้</div><div id="points">—</div>
    </div>

    <div class="row" style="margin-top:14px">
      <label for="adminSel" class="muted">รับแลกโดย</label>
      <select id="adminSel" style="min-width:220px">
        <option value="">— เลือกแอดมิน —</option>
      </select>
      <button id="btnConfirm">ยืนยันการแลก</button>
    </div>

    <div id="status" class="muted" style="margin-top:10px"></div>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";

/* ===== CONFIG ===== */
const firebaseConfig = {
  apiKey: "AIzaSyCMTpAce-Q-fTkS7xDDYuEpPwgtBIrDP04",
  authDomain: "anespoint-bfd3d.firebaseapp.com",
  databaseURL: "https://anespoint-bfd3d-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "anespoint-bfd3d",
  appId: "1:1234567890:web:abcdef123456"
};
const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbyxrm9HZ9q6Lov8KZ9ngQSPdAcOuz0fDcedK95f6heFo75crr7LCOopa1WDrhCpTRakoQ/exec";

const app = initializeApp(firebaseConfig);
const db  = getDatabase(app);

const $ = q => document.querySelector(q);
const fmt = n => Number(n||0).toLocaleString('th-TH');

function api(body){
  return new Promise((resolve,reject)=>{
    const cb='cb_'+Math.random().toString(36).slice(2);
    window[cb]=d=>{ resolve(d); delete window[cb]; s.remove(); };
    const qs=new URLSearchParams({...body,callback:cb}).toString();
    const s=document.createElement('script');
    s.src=`${GAS_ENDPOINT}?${qs}`; s.onerror=()=>reject(new Error('GAS error')); document.body.appendChild(s);
  });
}
function decodePayload(){
  try{
    const params=new URLSearchParams(location.hash.slice(1));
    const b64=params.get('p'); if(!b64) return null;
    const json=decodeURIComponent(escape(window.atob(b64)));
    return JSON.parse(json);
  }catch(e){ return null; }
}
async function loadAdmins(){
  const sel = $('#adminSel');
  sel.innerHTML = '<option value="">— เลือกแอดมิน —</option>';
  let list = null;
  try{
    const r = await api({action:'getAdmins'});
    if(r && r.ok && Array.isArray(r.items) && r.items.length){ list = r.items; }
  }catch(_){}
  if(!list){ list = ['ดุษฎี  อรรจน์อังกูร','จุฑาวุฒิ  อุ่นอมรมาศ','ANES-Front']; }
  list.forEach(name=>{
    const opt=document.createElement('option');
    opt.value=name; opt.textContent=name; sel.appendChild(opt);
  });
}

/* ===== main ===== */
const data = decodePayload();
if(!data){
  $('#status').textContent = 'ไม่พบข้อมูลจาก QR';
}else{
  $('#sap').textContent    = data.sap || '—';
  $('#reward').textContent = data.reward || '—';
  $('#points').textContent = fmt(data.pts || 0);
  try{
    const snap = await get(ref(db, 'public/usersSummary/'+data.sap));
    const v = snap.exists() ? snap.val() : {};
    $('#name').textContent = v.name || '(ไม่พบชื่อในระบบ)';
    if(!snap.exists()){ $('#name').classList.add('bad'); } else { $('#name').classList.add('ok'); }
  }catch(e){
    $('#name').textContent = '(อ่านชื่อไม่สำเร็จ)'; $('#name').classList.add('bad');
  }
}
await loadAdmins();

$('#btnConfirm').onclick = async()=>{
  if(!data) return;
  const admin = $('#adminSel').value.trim();
  if(!admin){ $('#status').textContent = 'กรุณาเลือกแอดมิน'; return; }
  $('#status').textContent='กำลังยืนยัน...';
  const r = await api({action:'confirmRedeem', sap:data.sap, rewardName:data.reward, admin, ts:data.ts, points:data.pts});
  if(r && r.ok){
    $('#status').innerHTML = `สำเร็จ ✓ | แต้มคงเหลือผู้ใช้: <b>${fmt(r.totalAfter)}</b> | สต็อกรางวัลคงเหลือ: <b>${fmt(r.stockAfter)}</b>`;
    $('#status').classList.remove('bad'); $('#status').classList.add('ok');
    $('#btnConfirm').disabled = true; $('#adminSel').disabled = true;
  }else{
    $('#status').textContent = 'ไม่สำเร็จ: ' + (r && r.error ? r.error : 'เกิดข้อผิดพลาด');
    $('#status').classList.remove('ok'); $('#status').classList.add('bad');
  }
};
</script>
</body>
</html>
